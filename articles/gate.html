<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="flowFate">
<title>03 Gating • flowFate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="03 Gating">
<meta property="og:description" content="flowFate">
<meta property="og:image" content="https://maximesunnen.github.io/flowFate/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flowFate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Curation.html">02 Curation</a>
    <a class="dropdown-item" href="../articles/Data-import.html">01 Import</a>
    <a class="dropdown-item" href="../articles/app-dockerisation.html">00 Dockerisation</a>
    <a class="dropdown-item" href="../articles/export.html">04 Export</a>
    <a class="dropdown-item" href="../articles/gate.html">03 Gating</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/maximesunnen/flowFate/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>03 Gating</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/maximesunnen/flowFate/blob/HEAD/vignettes/gate.Rmd" class="external-link"><code>vignettes/gate.Rmd</code></a></small>
      <div class="d-none name"><code>gate.Rmd</code></div>
    </div>

    
    
<p>The gating module comprises the most complex parts of our analysis
workflow. It consists of two crucial processes:</p>
<ul>
<li>binning the GFP+ population into subpopulations</li>
<li>split the MyHC+ and MyHC- population inside each GFP+
subpopulation</li>
</ul>
<div class="section level3">
<h3 id="binning-the-gfp-population">1) Binning the GFP+ population<a class="anchor" aria-label="anchor" href="#binning-the-gfp-population"></a>
</h3>
<p>The expression of GFP-labeled KRAS is not homogeneous within the GFP+
population. However, the magnitude of this expression may affect C2C12
cell differentiation. To analyze this effect, we need to increase the
granularity of our analysis by splitting (or binning) the GFP+
population into smaller subpopulations.</p>
<p>We allow users to customize the number and size of these
subpopulations using a numeric inputs. Users can add a maximum of three
subpopulations (low, medium, high). We use the
<code>gate_limits( )</code> function to fetch the users’s numeric inputs
and save them inside a list.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gate_limits</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Calculating gate limits..."</span>, <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>low <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_1</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_1</span><span class="op">)</span>,</span>
<span>              medium <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_2</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_2</span><span class="op">)</span> <span class="kw">else</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">}</span>,</span>
<span>              high <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_3</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">gfp_range_3</span><span class="op">)</span> <span class="kw">else</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">is.na</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The <code>gates</code> variable saves the GFP-low, GFP-medium and
GFP-high rectangle gates created from these inputs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gates</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Creating gates..."</span>, <span class="op">{</span></span>
<span>    <span class="co"># stop execution if gate_limits() is NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">gate_limits</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="co"># if gate_limits() is not NULL, execute code below</span></span>
<span>    <span class="va">filter_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GFP-low"</span>, <span class="st">"GFP-medium"</span>, <span class="st">"GFP-high"</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">gate_limits</span><span class="op">(</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">ch_kras</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="fu">rectangleGate</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">filterId</span> <span class="op">&lt;-</span> <span class="va">filter_names</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we add the gates to the GatingSet and recompute the
GatingSet to effectively split the GFP+ population into different
subpopulations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="fu">gates</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">gs_pop_add</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span>, <span class="fu">gates</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, parent <span class="op">=</span> <span class="st">"GFP+"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">recompute</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">confirm_bins</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="splitting-the-myhc-and-myhc--population">2) Splitting the MyHC+ and MyHC- population<a class="anchor" aria-label="anchor" href="#splitting-the-myhc-and-myhc--population"></a>
</h3>
<p>In our differentiation assay, the MyHC protein is targeted using an
eFluor660-labled antibody. This antibody emits fluorescence captured in
the red channel of our flow cytometer. Moreover, expression of this
protein correlated with cell differentiation. Thus, if cells
differentiate, they express more MyHC and consequently higher
fluorescence intensities are captured on our flow cytometer. A typical
distribution of red fluorescence observed for our differentiation assay
is illustrated below. The left peak (light blue) comprises cells that do
not express high amounts of MyHC and are considered undifferentiated. We
name this population MyHC-. The right peak (pale green) corresponds to
cells expressing high amounts of MyHC and are considered differentiated.
We name this population MyHC+.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2345</span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="fl">10</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">2500</span>, <span class="fl">35000</span>, <span class="fl">35000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"x"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"x"</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">a</span>,<span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">c</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">200</span>, fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"rect"</span>, xmin <span class="op">=</span> <span class="fl">1</span>, xmax <span class="op">=</span> <span class="fl">1000</span>, ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="fl">270</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"rect"</span>, xmin <span class="op">=</span> <span class="fl">1000</span>, xmax <span class="op">=</span> <span class="fl">200000</span>, ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="fl">150</span>, fill <span class="op">=</span> <span class="st">"palegreen"</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"RED.R.HLin (RFU)"</span><span class="op">)</span></span></code></pre></div>
<p>While a clear cutoff between these two peaks can be distinguished, we
have consistently observed that the exact location of this cutoff
changes from sample to sample. Thus, manually gating the MyHC+ cells is
time-consuming. In FlowFate, we automated this process using
<code>gate_flowclust_1d( )</code>, a data-driven gating function from
openCyto.</p>
<p>We wrapped the entire process into a custom function,
<code>getData_splitPeak( )</code>. Conveniently, the
<code>gate_flowclust_1d( )</code> not only determines a cutoff between
two populations but also immediately creates a gate from this cutoff.
Thus, the output from <code>getData_splitPeak( )</code> is a list of
gates. Sometimes biological samples are of poor quality and the GFP+
population or its subpopulation only count very few cells. If the number
of cells is too low, the algorithm behind
<code>gate_flowclust_1d( )</code> breaks which produces an error. To
stop the entire app from crashig, we use <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code>. For
samples where <code>gate_flowclust_1d( )</code> is unable to establish a
cutoff between the MyHC- and MyHC+ population, the resulting gate
evaluates to NULL. We remove these NULLs with another custom function,
<code>remove_null_from_list( )</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">getData_splitPeak</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">gs</span>, <span class="va">bin</span>, <span class="va">filter_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## fetch the data we need. bin = name of the gate to extract data from, used to access "GFP-low", "GFP-medium" and "GFP-high" gates</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">gs_pop_get_data</span><span class="op">(</span><span class="va">gs</span>, <span class="va">bin</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">cytoset_to_flowSet</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">## x is a flowSet. To each flowFrame, we apply the function tryCatch(). If no error, returns a gate that cuts between myosin peaks. If error, the respective gate evaluates to NULL</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">fsApply</span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fr</span>, <span class="va">filterId</span> <span class="op">=</span> <span class="va">filter_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu">gate_flowclust_1d</span><span class="op">(</span><span class="va">fr</span>, params <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="fu">ch_myhc</span><span class="op">(</span><span class="op">)</span>, K <span class="op">=</span> <span class="fl">2</span>, cutpoint_method <span class="op">=</span> <span class="st">"min_density"</span>, filterId <span class="op">=</span> <span class="va">filterId</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co">## we don't want the gates that evaluate to NULL, so we remove them using the custom function remove_null_from_list()</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">remove_null_from_list</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">remove_null_from_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## capture the indices of the the elements that are NULL, assign indices to test variable</span></span>
<span>  <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">is.null</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## when no NULLs (test variable of size 0), return the input data</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">## when NULLs identified (test variable of size != 0), return the input data WITHOUT the positions that were NULL</span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">test</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that everything <code>getData_splitPeak( )</code> is supposed to
do is to (1) look at the fluorescent intensity distribution in the red
channel of every dataset and (2) find a threshold between the MyHC- and
MyHC+ peaks for for each dataset and create a gate from it. Remember
that we have previously split the GFP+ population into one, two or three
subpopulations, depending on the user’s choices. Thus, for each dataset
we also need to establish one, two or three MyHC+ gates. This is why we
set the <code>bin</code> argument <code>getData_splitPeak( )</code> to
either <code>GFP-low</code>, <code>GFP-medium</code> or
<code>GFP-high</code>. Below, we save the MyHC+ gates for each of these
subpopulations (or bins) and for all the samples in three different
variables.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gfp_low_myo_high</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">req</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Retrieving data from GFP-low bin..."</span>, <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="fu">gs_get_pop_paths</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span>, <span class="st">"GFP-low"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co">#make sure GFP-low exists!</span></span>
<span>      <span class="fu">getData_splitPeak</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, bin <span class="op">=</span> <span class="st">"GFP-low"</span>, filter_name <span class="op">=</span> <span class="st">"MyHC+"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">gfp_medium_myo_high</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">req</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Retrieving data from GFP-low bin..."</span>, <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="fu">gs_get_pop_paths</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span>, <span class="st">"GFP-medium"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co">#make sure GFP-medium exists!</span></span>
<span>      <span class="fu">getData_splitPeak</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, bin <span class="op">=</span> <span class="st">"GFP-medium"</span>, filter_name <span class="op">=</span> <span class="st">"MyHC+"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">gfp_high_myo_high</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">req</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span>
<span>  <span class="fu">withProgress</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Retrieving data from GFP-high bin..."</span>, <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="fu">gs_get_pop_paths</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span>, <span class="st">"GFP-high"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co">#make sure GFP-high exists!</span></span>
<span>      <span class="fu">getData_splitPeak</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, bin <span class="op">=</span> <span class="st">"GFP-high"</span>, filter_name <span class="op">=</span> <span class="st">"MyHC+"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Once all these cutoffs have been determined and MyHC+ gates created,
the actual gating is achieved by adding the gates to the GatingSet and
recomputing the GatingSet. The function below first checks if one of the
gate lists (<code>gfp_low_myo_high</code>,
<code>gfp_medium_myo_high</code>, <code>gfp_high_myo_high</code>) is
NULL. If not, the gate is added using the custom
<code>add_gate( )</code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">gfp_low_myo_high</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span><span class="fu">add_gate</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, gate <span class="op">=</span> <span class="fu">gfp_low_myo_high</span><span class="op">(</span><span class="op">)</span>, parent <span class="op">=</span> <span class="st">"GFP-low"</span><span class="op">)</span><span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">gfp_medium_myo_high</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span><span class="fu">add_gate</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, gate <span class="op">=</span> <span class="fu">gfp_medium_myo_high</span><span class="op">(</span><span class="op">)</span>, parent <span class="op">=</span> <span class="st">"GFP-medium"</span><span class="op">)</span><span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">gfp_high_myo_high</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span><span class="fu">add_gate</span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>, gate <span class="op">=</span> <span class="fu">gfp_high_myo_high</span><span class="op">(</span><span class="op">)</span>, parent <span class="op">=</span> <span class="st">"GFP-high"</span><span class="op">)</span><span class="op">}</span></span>
<span>  <span class="fu">observer.state.split</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">updateTabsetPanel</span><span class="op">(</span>inputId <span class="op">=</span> <span class="st">"tabset-mainPanel"</span>, selected <span class="op">=</span> <span class="st">"Plot"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">split</span><span class="op">)</span></span></code></pre></div>
<p><code>add_gate( )</code> adds a gate to the matching GatingSet sample
and recomputes the GatingSet.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_gate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">gs</span>, <span class="va">gate</span>, <span class="va">parent</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">gate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gate</span><span class="op">)</span></span>
<span>  <span class="va">gatingSet_names</span> <span class="op">&lt;-</span> <span class="fu">sampleNames</span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">gatingSet_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">gatingSet_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">gate_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">gatingSet_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="va">gate_names</span><span class="op">)</span> <span class="co"># gives the index of the name in gate_names that matches gatingSet_names</span></span>
<span>      <span class="fu">gs_pop_add</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, gate <span class="op">=</span> <span class="va">gate</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, parent <span class="op">=</span> <span class="va">parent</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">recompute</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The data analysis is now complete. Below is a recap of what has been
achieved:</p>
<ol style="list-style-type: decimal">
<li>FCS files were read into R</li>
<li>The GFP signal captured from control samples was used to establish a
threshold defining a GFP+ population of transfected cells.</li>
<li>The GFP+ population was split into distinct subpopulations based on
a user-defined intensity interval. This allows us to investigate the
effect of the extent of KRAS expression on C2C12 differentiation.</li>
<li>Inside each GFP subpopulation, we gated the differentiated cells
using a data-driven, peak-splitting algorithm.</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Maxime Sünnen, Aurélien Ginolhac.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
