<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>02 Curation • flowFate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="02 Curation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flowFate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/app-dockerisation.html">00 Dockerisation</a></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">00 Get started</a></li>
    <li><a class="dropdown-item" href="../articles/Data-import.html">01 Import</a></li>
    <li><a class="dropdown-item" href="../articles/Curation.html">02 Curation</a></li>
    <li><a class="dropdown-item" href="../articles/gate.html">03 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/export.html">04 Export</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/maximesunnen/flowFate/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>02 Curation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/maximesunnen/flowFate/blob/main/vignettes/Curation.Rmd" class="external-link"><code>vignettes/Curation.Rmd</code></a></small>
      <div class="d-none name"><code>Curation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="gating-live-cells">Gating live cells<a class="anchor" aria-label="anchor" href="#gating-live-cells"></a>
</h2>
<p>Preparing samples for flow cytometry inevitably damages or kills some
cells. These “debris” need to be excluded from subsequent analysis.
Cellular debris can be identified in SSC vs FSC plots, enabling their
easy removal using gates.</p>
<p><img src="../reference/figures/ssc_fsc_ungated.png" width="55%" style="display: block; margin: auto;"></p>
<p>In FlowFate, debris removal is accomplished using a hard-coded
rectangle gate, meaning that the gate boundaries are
<strong>predefined</strong> and cannot be modified by users. It is
essential for users to consider this aspect during acquisition to ensure
that intact cells accumulate within the specified window (for more
information, see below).</p>
<div class="section level3">
<h3 id="set-up-the-gate-matrix">1) Set up the gate matrix<a class="anchor" aria-label="anchor" href="#set-up-the-gate-matrix"></a>
</h3>
<p>We first need to set up an <strong>m x n</strong> gate matrix:</p>
<ul>
<li><p><strong>n</strong> (number of columns) corresponds to the gating
dimensions. Here n = 2 (SSC + FSC).</p></li>
<li><p><strong>m</strong> (number of rows) corresponds to the number of
individual points that make up the rectangle gate. Here m = 5.</p></li>
</ul>
<p>Each <em>row</em> comprises the X and Y coordinates of a gate edge.
Here we use a polygon with 5 edges, thus the gating matrix has 5 rows.
The column names have to be renamed becuase they need to match the
channel names used to gate the data (here SSC.HLin and FSC.HLin).</p>
<p><strong>Note:</strong> Forward- and side-scatter channel names vary
depending on the flow cytometer used. Below, for illustration purposes,
we name them “SSC.HLin” and “FSC.HLin” because this matches the channel
names from our machine. In FlowFate, the corresponding channels can be
selected by the user.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># creating the gate matrix</span></span>
<span><span class="va">pgn_cut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12500</span>, <span class="fl">99000</span>, <span class="fl">99000</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">6250</span>, <span class="fl">6250</span>, <span class="fl">99000</span>, <span class="fl">99000</span>,<span class="fl">12500</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co"># renaming the columns to match the gating dimensions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pgn_cut</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SSC.HLin"</span>, <span class="st">"FSC.HLin"</span><span class="op">)</span></span></code></pre></div>
<p>The gating matrix now looks like this</p>
<pre><code><span><span class="co">#&gt;      SSC.HLin FSC.HLin</span></span>
<span><span class="co">#&gt; [1,]    12500     6250</span></span>
<span><span class="co">#&gt; [2,]    99000     6250</span></span>
<span><span class="co">#&gt; [3,]    99000    99000</span></span>
<span><span class="co">#&gt; [4,]        0    99000</span></span>
<span><span class="co">#&gt; [5,]        0    12500</span></span></code></pre>
<p>and the created gate like this (red rectangle)</p>
<p><img src="../reference/figures/ssc_fsc_gated.png" width="70%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="create-the-nondebris-gate">2) Create the NonDebris gate<a class="anchor" aria-label="anchor" href="#create-the-nondebris-gate"></a>
</h3>
<p>Until now we have only create the gating matrix. We use this matrix
to create a NonDebris gate with <a href="https://bioconductor.org/packages/release/bioc/html/flowCore.html" class="external-link">flowCore’s</a>
<code>polygonGate( )</code> function. The <code>filterId</code> argument
uniquely identifies the gate.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gate_non_debris</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="fu">polygonGate</span><span class="op">(</span>filterId <span class="op">=</span> <span class="st">"NonDebris"</span>, .gate <span class="op">=</span> <span class="va">pgn_cut</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="gate-the-data">3) Gate the data<a class="anchor" aria-label="anchor" href="#gate-the-data"></a>
</h3>
<p>We apply the gate to our data by <strong>adding</strong> the
NonDebris gate to the GatingSet <code>r$gs</code> (see data import
vignette) using <code>gs_pop_add( )</code>. We then need to
<code>recompute( )</code> <code>r$gs</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gs_pop_add</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span>, <span class="fu">gate_non_debris</span><span class="op">(</span><span class="op">)</span>, parent <span class="op">=</span> <span class="st">"root"</span><span class="op">)</span></span>
<span><span class="fu">recompute</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="gating-gfp-cells">Gating GFP+ cells<a class="anchor" aria-label="anchor" href="#gating-gfp-cells"></a>
</h2>
<p>FlowFate was designed to study the effect of GFP-labeled KRAS on
C2C12 differentiation. Consequently, our analysis must concentrate on
successfully transfected cells. Nonetheless, background noise and
autofluorescence introduce unspecific fluorescent signals from
untransfected cells. To address this, we use a GFP-threshold in our data
analysis to effectively exclude untransfected cells with emissions below
a specified threshold. This approach ensures that our analysis focuses
on relevant, transfected cells while excluding undesired noise.</p>
<p>The GFP threshold is determined using our two control samples:</p>
<ul>
<li><p>a <strong>double-negative control</strong> sample: untransfected,
unlabelled C2C12</p></li>
<li><p>a <strong>MyHC-only control</strong> sample: untransfected C2C12,
labelled with an eFluor660-labeled antibody targeting the heavy-chain of
the myosin protein (MyHC).</p></li>
</ul>
<p>In the control samples, the fluorescence signals observed in the
green channel “GRN.B.HLin” are a result of cellular autofluorescence and
thus unspecific. Thus, by analyzing the intensity distribution, we can
establish a threshold that effectively excludes a majority of the
events. This threshold (red line in the figure below) becomes a
reference point to distinguish between untransfected cells (falling
below this treshold) and transfected cells (above this threshold).</p>
<p>To gate the transfected cells in all our datasets, we apply this
established threshold and remove cells falling below it.</p>
<p><img src="../reference/figures/gfp_threshold.png" width="70%" style="display: block; margin: auto;"></p>
<div class="section level3">
<h3 id="determine-a-gfp-threshold">1) Determine a GFP threshold<a class="anchor" aria-label="anchor" href="#determine-a-gfp-threshold"></a>
</h3>
<p>Most of the computation is wrapped inside a custom function
<code>get_lowerLimit( )</code>. This function has several arguments:</p>
<ul>
<li>
<strong>gs</strong>: GatingSet to use</li>
<li>
<strong>datasets</strong>: Datasets used to establish the threshold
(i.e. control samples)</li>
<li>
<strong>node</strong>: Existing gate to extract data from. For
example, we establish the GFP threshold based on the intensity
distribution in the green channel of <strong>intact</strong> cells.
Thus, we need to use the data from the NonDebris gate.</li>
<li>
<strong>ch_gate</strong>: the channel based on which the gate is
determined (here the GPF channel “GRN.B.HLin”)</li>
<li>
<strong>r</strong>: required to use the <a href="https://thinkr-open.github.io/golem/" class="external-link">golem</a>
framework</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_lowerLimit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gs</span>, <span class="va">datasets</span>, <span class="va">node</span>, <span class="va">ch_gate</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># extract the data as a flowSet</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">gs_pop_get_data</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">[[</span><span class="va">datasets</span><span class="op">]</span><span class="op">]</span>, <span class="va">node</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">cytoset_to_flowSet</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># create a quantile gate using extracted data and the respective channel name</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">create_quantile_gate</span><span class="op">(</span><span class="va">x</span>, gate_channel <span class="op">=</span> <span class="va">ch_gate</span><span class="op">)</span></span>
<span>  <span class="co"># average the minimum values from the respective quantile gateS(!)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">min</span>, <span class="va">y</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">min</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We use <a href="https://bioconductor.org/packages/release/bioc/html/openCyto.html" class="external-link">openCyto’s</a>
<code>gate_quantile( )</code> function to algorithmically establish the
GFP threshold. Based on the <code>probs</code> (probabilities) argument,
this function determines sample quantiles and create a rectangle gate
excluding events outside this quantile. For example, if
<code>probs = 0.25</code> or <code>probs = 0.5</code>,
<code>gate_quantile( )</code> establishes the threshold at the first or
second quartile, respectively. The created interval gate then ranges
from the established threshold to infinity.</p>
<p>In our case, we used <code>probs = 0.99</code> to exclude 99% of the
events in our control samples. To avoid unreasonably high thresholds due
to outliers we did not use <code>probs = 1</code> which may have lead to
a loss of transfected cells. In addition, we averaged the threshold
obtained from both control samples and store this value in the
<code>lower_limit_gfp_gate</code> variable.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lower_limit_gfp_gate</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">get_lowerLimit</span><span class="op">(</span>gs <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">gs</span>,</span>
<span>                 datasets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">negative_control</span>, <span class="va">input</span><span class="op">$</span><span class="va">positive_control_myhc</span><span class="op">)</span>,</span>
<span>                 node <span class="op">=</span> <span class="st">"NonDebris"</span>,</span>
<span>                 ch_gate <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">kras_channel</span>,</span>
<span>                 r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">Curate</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-a-gfp-gate">2) Create a GFP gate<a class="anchor" aria-label="anchor" href="#create-a-gfp-gate"></a>
</h3>
<p>Until now we have only established an adequate GFP threshold. We now
use it to create a <code>gfp_gate</code>. The computations are wrapped
in the custom function <code>make_gate( )</code>. The logic behind this
gate was described above.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_gate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lower_limit</span>, <span class="va">col_name</span>, <span class="va">filterId</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lower_limit</span>, <span class="cn">Inf</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">col_name</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">rectangleGate</span><span class="op">(</span>filterId <span class="op">=</span> <span class="va">filterId</span>, .gate <span class="op">=</span> <span class="va">mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gfp_gate</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">make_gate</span><span class="op">(</span><span class="fu">lower_limit_gfp_gate</span><span class="op">(</span><span class="op">)</span>,</span>
<span>            <span class="va">input</span><span class="op">$</span><span class="va">kras_channel</span>,</span>
<span>            filterId <span class="op">=</span> <span class="st">"GFP+"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="apply-the-gfp-gate">3) Apply the GFP gate<a class="anchor" aria-label="anchor" href="#apply-the-gfp-gate"></a>
</h3>
<p>To gate the transfected cells in all our datasets, we add the
<code>gfp_gate</code> to the GatingSet and recomputing the
GatingSet.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add the gfp_gate to the GatingSet</span></span>
<span><span class="fu">gs_pop_add</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span>, <span class="fu">gfp_gate</span><span class="op">(</span><span class="op">)</span>, parent <span class="op">=</span> <span class="st">"NonDebris"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#recompute the GatingSet</span></span>
<span><span class="fu">recompute</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Maxime Sünnen, Aurélien Ginolhac.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
